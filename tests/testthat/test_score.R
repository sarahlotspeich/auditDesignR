# context("score function")
library(testthat)
library(auditDesignR)

test_that("Xonly", {

	# Set sample sizes ----------------------------------------
	N <- 10000 # Phase-I = N
	n <- 400 # Phase-II/audit size = n

	# Misclassification rates ---------------------------------
	fpr_Xstar <- 0.1; tpr_Xstar <- 0.9

	eta <- vector() # Nuisance parameters eta

	# True parameter values for P(Y|X) --------------------------
	pY <- 0.3
	eta[1] <- log(pY / (1 - pY))
	beta <- 0.3

	# True parameter value for P(X) -----------------------------
	pX <- 0.1
	eta[5] <- log(pX / (1 - pX))

	# Parameters for error model P(X*|X,Y) ----------------------
	eta[2] <- - log((1 - fpr_Xstar) / fpr_Xstar)
	eta[3] <- - log((1 - tpr_Xstar) / tpr_Xstar) - eta[2]
	eta[4] <- (beta + 0.15)
	
	set.seed(918)

	complete_data <- expand.grid(Y = c(0, 1), X = c(0, 1), Xstar = c(0, 1), V = c(0, 1))
	s <- score(comp_dat = complete_data, Y_val = "Y", X_val = "X", X_unval = "Xstar", Validated = "V", beta = beta, eta = eta)

	expect_equal(s[["Si_beta"]], c(0,0,-0.366491552961106,0.633508447038894,0,0,-0.366491552961106,0.633508447038894,-0.0318417414449399,0.0522037117617802,-0.0475880618409843,0.0782090863941109))
	expect_equal(s[["Si_gamma1"]], c(-0.3,0.7,-0.366491552961106,0.633508447038894,-0.3,0.7,-0.366491552961106,0.633508447038894,-0.305776959443005,0.694520821495595,-0.308633770979578,0.691791358687764))
	expect_equal(s[["Si_gamma2"]], c(-0.1,-0.9,-0.148397601997734,-0.933839722638139,0.9,0.1,0.851602398002266,0.0661602773618608,-0.104204909818291,-0.902788532867963,0.893715685782619,0.0958223543762844))
	expect_equal(s[["Si_gamma3"]], c(0,-0.9,0,-0.933839722638139,0,0.1,0,0.0661602773618608,0,-0.902788532867963,0,0.0958223543762844))
	expect_equal(s[["Si_gamma4"]], c(0,0,-0.148397601997734,-0.933839722638139,0,0,0.851602398002266,0.0661602773618608,-0.012893170485603,-0.076952248924487,0.110578558366837,0.00816774404861951))
	expect_equal(s[["Si_gamma5"]], c(-0.1,-0.1,0.9,0.9,-0.1,-0.1,0.9,0.9,-0.0131173933268822,-0.0175958710483064,0.0298476362046865,0.0234538967233523))
	expect_equal(s[["joint_exV"]], c(0.567,0.027,0.0539497312653014,0.00242471827946859,0.063,0.243,0.00940111343858801,0.034224437016642,0.620949731265302,0.0294247182794686,0.072401113438588,0.277224437016642))

	})

test_that("Yonly", {
	# Set sample sizes ----------------------------------------
	N <- 10000 # Phase-I = N
	n <- 400 # Phase-II/audit size = n

	# Misclassification rates ---------------------------------
	fpr_Ystar <- 0.1; tpr_Ystar <- 0.9

	eta <- vector() # Nuisance parameters eta

	# True parameter values for P(Y|X) --------------------------
	pY <- 0.3
	eta[1] <- log(pY / (1 - pY))
	beta <- 0.3

	# True parameter value for P(X) -----------------------------
	pX <- 0.1
	eta[5] <- log(pX / (1 - pX))

	# Parameters for error model P(Y*|X*,Y,X) -------------------
	eta[2] <- - log((1 - fpr_Ystar) / fpr_Ystar)
	eta[3] <- - log((1 - tpr_Ystar) / tpr_Ystar) - eta[2]
	eta[4] <- (beta + 0.25) / 2

	set.seed(918)

	complete_data <- expand.grid(Y = c(0, 1), X = c(0, 1), Ystar = c(0, 1), V = c(0, 1))
	s <- score(comp_dat = complete_data, Y_val = "Y", Y_unval = "Ystar", X_val = "X", Validated = "V", beta = beta, eta = eta)

	expect_equal(s[["Si_beta"]],  c(0,0,-0.366491552961106,0.633508447038894,0,0,-0.366491552961106,0.633508447038894,0,-0.31741366019306,0,0.440476080940009))
	expect_equal(s[["Si_gamma1"]],c(-0.3,0.7,-0.366491552961106,0.633508447038894,-0.3,0.7,-0.366491552961106,0.633508447038894,-0.254545454545455,-0.31741366019306,0.494117647058824,0.440476080940009))
	expect_equal(s[["Si_gamma2"]],c(-0.1,-0.9,-0.127613702353918,-0.922171575389314,0.9,0.1,0.872386297646082,0.0778284246106861,-0.136363636363636,-0.166608928444756,0.264705882352941,0.231203810845206))
	expect_equal(s[["Si_gamma3"]],c(0,-0.9,0,-0.922171575389314,0,0.1,0,0.0778284246106861,-0.0409090909090909,-0.0452582376906971,0.0794117647058824,0.0628050196583366))
	expect_equal(s[["Si_gamma4"]],c(0,0,-0.127613702353918,-0.922171575389314,0,0,0.872386297646082,0.0778284246106861,0,-0.166608928444756,0,0.231203810845206))
	expect_equal(s[["Si_gamma5"]],c(-0.1,-0.1,0.9,0.9,-0.1,-0.1,0.9,0.9,-0.1,0.9,-0.1,0.9))
	expect_equal(s[["joint_exV"]],c(0.567,0.027,0.055266408863978,0.00285234602000867,0.063,0.243,0.00808443583991143,0.0337968092761019,0.594,0.0581187548839867,0.306,0.0418812451160133))
	
	})